version: '3.8'

services:
  goth:
    build:
      context: ./goth # The context is the root of the project
      dockerfile: Dockerfile # Use the new Dockerfile with entrypoint
    container_name: goth
    ports:
      - "8000:8000"
    command: [] # Command is executed by the entrypoint script
    env_file:
      - .env # Load environment variables from .env file
    depends_on:
      - resource-server
      - keycloak
      - redis
    restart: unless-stopped
    networks:
      - goth-net

  resource-server:
    build:
      context: ./resource-server
      dockerfile: Dockerfile
    container_name: resource-server
    ports:
      - "8888:80" # Changed to 8081 to avoid conflict
    restart: unless-stopped
    networks:
      - goth-net

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    env_file:
      - .env # Load environment variables from .env file
    command: ["start-dev", "--health-enabled=true", "--import-realm", "--features=scripts"]
    volumes:
      - ./keycloak:/opt/keycloak/data/import # For realm import
    ports:
      - "8080:8080" # Expose Keycloak on port 9090
      - "9000:9000" # Expose the health check on port 9099
    restart: unless-stopped
    networks:
      - goth-net

  keycloak-init:
    build:
      context: ./keycloak-init
      dockerfile: Dockerfile
    container_name: keycloak-init
    working_dir: /setup
    volumes:
      - ./keycloak-init:/setup
    env_file:
      - .env
    depends_on:
      - keycloak
    networks:
      - goth-net
    restart: "no"

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - goth-net

  token-service:
    build:
      context: ./token-service
      dockerfile: Dockerfile
    container_name: token-service
    ports:
      - "5000:5000" # Expose token service on port 5000
    env_file:
      - .env # Load environment variables from .env file
    depends_on:
      - keycloak
    networks:
      - goth-net
    restart: unless-stopped

networks:
  goth-net:
