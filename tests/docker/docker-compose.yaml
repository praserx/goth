version: '3.8'

services:
  aegis:
    build:
      context: ./aegis # The context is the root of the project
      dockerfile: Dockerfile # Use the new Dockerfile with entrypoint
    container_name: aegis
    ports:
      - "8000:8000"
    command: [] # Command is executed by the entrypoint script
    environment:
      # --- Goth Application Configuration ---
      - WEB_LISTEN_HTTP=:8000
      - WEB_COOKIE_SECURE=false # Set to true if using HTTPS
      - WEB_COOKIE_SAME_SITE=lax

      - PROXY_UPSTREAM_URL=http://resource-server:80
      
      - OIDC_DISCOVERY_URL=http://keycloak:8080/realms/test/.well-known/openid-configuration
      - OIDC_CLIENT_ID=application # Must match TARGET_CLIENT_ID
      - OIDC_CLIENT_SECRET= # This is now set by the entrypoint script
      - OIDC_TLS_SKIP_VERIFY=true
      - OIDC_CALLBACK_PATH=http://localhost:8000/auth/callback # Callback URL for OIDC
      - REDIS_URL=redis:6379 # Address for the Redis service

      # --- Entrypoint Script Configuration ---
      - KEYCLOAK_URL=http://keycloak:8080 # Use the internal port for container-to-container communication
      - KEYCLOAK_ADMIN_USER=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KEYCLOAK_REALM=test # The realm to use
      - TARGET_CLIENT_ID=application # Client whose secret will be fetched
      - HEALTH_CHECK_URL=http://keycloak:9000/health # Health check URL for Keycloak
    depends_on:
      - resource-server
      - keycloak
      - redis
    restart: unless-stopped
    networks:
      - aegis-net

  resource-server:
    build:
      context: ./resource-server
      dockerfile: Dockerfile
    container_name: resource-server
    ports:
      - "8888:80" # Changed to 8081 to avoid conflict
    restart: unless-stopped
    networks:
      - aegis-net

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    command: ["start-dev", "--health-enabled=true", "--import-realm", "--features=scripts"]
    volumes:
      - ./keycloak-config:/opt/keycloak/data/import # For realm import
    ports:
      - "8080:8080" # Expose Keycloak on port 9090
      - "9000:9000" # Expose the health check on port 9099
    restart: unless-stopped
    networks:
      - aegis-net

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - aegis-net

networks:
  aegis-net:
